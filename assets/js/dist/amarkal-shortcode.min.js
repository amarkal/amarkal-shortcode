!function(a,b){function c(a){this.shortcode=a}function d(a){this.shortcode=a}function e(a,b,e){this.id=a,this.config=b,this.ed=e,this.popup=new c(this),this.placeholder=new d(this)}c.prototype.onOpen=function(b){for(name in b){var c=a("#"+this.shortcode.id+".mce-window").find('[amarkal-component-name="'+name+'"]'),d=b[name];c.amarkalUIComponent().amarkalUIComponent("setValue",d)}},c.prototype.onClose=function(){this.shortcode.ed.windowManager.close()},c.prototype.onInsert=function(){var b={},c=this.shortcode.placeholder.encodeValue,d=a(this.shortcode.ed.selection.getNode());a("#"+this.shortcode.id+".mce-window").find(".amarkal-ui-component").each(function(){var d=a(this).amarkalUIComponent("getValue"),e=a(this).attr("amarkal-component-name");b[e]=c(d)}),void 0!==d.attr("data-amarkal-shortcode")&&d.remove(),this.shortcode.ed.selection.setContent(this.shortcode.parseTemplate(this.shortcode.config.template,b)),this.shortcode.ed.windowManager.close()},d.prototype.edit=function(b){var c=b.attr("data-amarkal-shortcode"),d=wp.shortcode.next(this.shortcode.id,window.decodeURIComponent(c)),e=a.extend({},d.shortcode.attrs.named,{content:d.shortcode.content});this.shortcode.ed.execCommand(this.shortcode.config.cmd,this.decodeValues(e)),this.shortcode.ed.selection.select(b[0])},d.prototype.delete=function(a){a.remove()},d.prototype.decodeValue=function(a){return JSON.parse(decodeURIComponent(a))},d.prototype.decodeValues=function(a){var b=this.decodeValue,c={};return Object.keys(a).forEach(function(d){c[d]=b(a[d])}),c},d.prototype.encodeValue=function(a){return encodeURIComponent(JSON.stringify(a))},d.prototype.encodeValues=function(a){var b=this.encodeValue,c={};return Object.keys(a).forEach(function(d){c[d]=b(a[d])}),c},e.prototype.init=function(){var b=this;this.ed.addCommand(this.config.cmd,function(c){void 0===c&&(c=b.getDefaultValues()),b.ed.windowManager.open({title:b.config.title,onOpen:b.popup.onOpen.bind(b.popup,c),width:b.config.width,height:b.config.height,id:b.id,html:b.config.html,buttons:[{text:"Insert",classes:"widget btn primary first abs-layout-item",disabled:!1,onclick:b.popup.onInsert.bind(b.popup)},{text:"Close",onclick:b.popup.onClose.bind(b.popup)}]}),a("#"+b.id+" .amarkal-ui-component").each(function(){a(this).amarkalUIComponent("refresh")})}),b.ed.on("BeforeSetContent",function(a){a.content=b.replaceShortcodes(a.content)}),b.ed.on("PostProcess",function(a){a.get&&(a.content=b.restoreShortcodes(a.content))}),b.ed.on("click",function(c){var d=a(c.target),e=a(c.target.parentElement),f=decodeURIComponent(e.attr("data-amarkal-shortcode"));"I"===c.target.nodeName&&e.hasClass("amarkal-shortcode-placeholder")&&wp.shortcode.next(b.id,f)&&(d.is(":first-child")&&b.placeholder.delete.call(b.placeholder,e),d.is(":last-child")&&b.placeholder.edit.call(b.placeholder,e))})},e.prototype.getDefaultValues=function(){for(var a={},b=0;b<this.config.fields.length;b++){var c=this.config.fields[b];void 0!==c.default&&(a[c.name]=c.default)}return a},e.prototype.parseTemplate=function(a,b){return a.replace(/(\{\{([\w\d-]*)\}\})/g,function(a,c,d){return b[d.trim()]})},e.prototype.replaceShortcodes=function(a){var b=this;return wp.shortcode.replace(this.id,a,function(a){return b.html(a)})},e.prototype.restoreShortcodes=function(a){function b(a,b){return b=new RegExp(b+'="([^"]+)"').exec(a),b?window.decodeURIComponent(b[1]):""}return a.replace(/(<div( [^>]+)?>)*<i><\/i><i><\/i>\.(?:<\/div>)*/g,function(a,c){var d=b(c,"data-amarkal-shortcode");return d?"<p>"+d+"</p>":a})},e.prototype.html=function(a){var b=this.config.placeholder_class?" "+this.config.placeholder_class:"";return wp.html.string({tag:"div",content:"<i></i><i></i>.",attrs:{class:"amarkal-shortcode-placeholder mceItem"+b,"data-amarkal-shortcode":window.encodeURIComponent(a.string()),"data-title":this.config.title,"data-subtitle":this.config.placeholder_subtitle?this.parseTemplate(this.config.placeholder_subtitle,this.placeholder.decodeValues(a.attrs.named)):"",style:this.config.placeholder_icon?"background-image:url("+this.config.placeholder_icon+")":""}})};var f=JSON.parse(a("#amarkal-shortcode-json").html());tinymce.create("tinymce.plugins.amarkal_shortcode",{init:function(a,b){for(var c in f){new e(c,f[c],a).init()}}}),tinymce.PluginManager.add("amarkal_shortcode",tinymce.plugins.amarkal_shortcode)}(jQuery,window);