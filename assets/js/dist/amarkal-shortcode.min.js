!function(a,b){function c(a,b,c){this.id=a,this.config=b,this.ed=c}c.prototype.init=function(){var b=this;this.ed.addCommand(this.config.cmd,function(c){void 0===c&&(c=b.getDefaultValues()),b.ed.windowManager.open({title:b.config.title,onOpen:b.popup.onOpen.bind(b,c),width:b.config.width,height:b.config.height,id:b.id,html:b.config.html,buttons:[{text:"Insert",classes:"widget btn primary first abs-layout-item",disabled:!1,onclick:b.popup.onInsert.bind(b)},{text:"Close",onclick:b.popup.onClose.bind(b)}]}),a("#"+b.id+" .amarkal-ui-component").each(function(){a(this).amarkalUIComponent("refresh")})}),b.ed.on("BeforeSetContent",function(a){a.content=b.replaceShortcodes(a.content)}),b.ed.on("PostProcess",function(a){a.get&&(a.content=b.restoreShortcodes(a.content))}),b.ed.on("click",function(c){var d=a(c.target),e=a(c.target.parentElement);"I"===c.target.nodeName&&e.hasClass("amarkal-shortcode-placeholder")&&(d.is(":first-child")&&b.placeholder.delete.call(b,e),d.is(":last-child")&&b.placeholder.edit.call(b,e))})},c.prototype.getDefaultValues=function(){for(var a={},b=0;b<this.config.fields.length;b++){var c=this.config.fields[b];void 0!==c.default&&(a[c.name]=c.default)}return a},c.prototype.popup={onOpen:function(b){for(name in b){a("#"+this.id+".mce-window").find('[amarkal-component-name="'+name+'"]').amarkalUIComponent().amarkalUIComponent("setValue",b[name])}},onClose:function(){this.ed.windowManager.close()},onInsert:function(b){var c={};a("#"+this.id+".mce-window").find(".amarkal-ui-component").each(function(){var b=a(this).amarkalUIComponent("getValue"),d=a(this).attr("amarkal-component-name");c[d]=b,console.log(d,b)}),this.ed.selection.setContent(this.parseTemplate(this.config.template,c)),this.ed.windowManager.close()}},c.prototype.placeholder={edit:function(b){var c=b.attr("data-amarkal-shortcode"),d=wp.shortcode.next(this.id,window.decodeURIComponent(c)),e=a.extend({},d.shortcode.attrs.named,{content:d.shortcode.content});this.ed.execCommand(this.config.cmd,e),this.ed.selection.select(b[0])},delete:function(a){a.remove()}},c.prototype.parseTemplate=function(a,b){return a.replace(/(\{\{([\w\d-]*)\}\})/g,function(a,c,d){return b[d.trim()]})},c.prototype.replaceShortcodes=function(a){var b=this;return wp.shortcode.replace("my-alert",a,function(a){return b.html(a)})},c.prototype.restoreShortcodes=function(a){function b(a,b){return b=new RegExp(b+'="([^"]+)"').exec(a),b?window.decodeURIComponent(b[1]):""}return a.replace(/(<div( [^>]+)?>)*<i><\/i><i><\/i>\.(?:<\/div>)*/g,function(a,c){var d=b(c,"data-amarkal-shortcode");return d?"<p>"+d+"</p>":a})},c.prototype.html=function(a){var b=this.config.placeholder_class?" "+this.config.placeholder_class:"";return wp.html.string({tag:"div",content:"<i></i><i></i>.",attrs:{class:"amarkal-shortcode-placeholder mceItem"+b,"data-amarkal-shortcode":window.encodeURIComponent(a.string()),"data-title":this.config.title,"data-vfv":this.config.placeholder_visible_field?a.attrs.named[this.config.placeholder_visible_field]:"",style:this.config.placeholder_icon?"background-image:url("+this.config.placeholder_icon+")":""}})};var d=JSON.parse(a("#amarkal-shortcode-json").html());tinymce.create("tinymce.plugins.amarkal_shortcode",{init:function(a,b){for(var e in d){new c(e,d[e],a).init()}}}),tinymce.PluginManager.add("amarkal_shortcode",tinymce.plugins.amarkal_shortcode)}(jQuery,window);