!function(e){function t(e){this.shortcode=e}function o(e){this.shortcode=e}function n(e,n,a){this.id=e,this.config=n,this.ed=a,this.popup=new t(this),this.placeholder=new o(this)}t.prototype.onOpen=function(e){var t=a("#"+this.shortcode.id+".mce-window").find("#amarkal-shortcode-form"),o=t.find(".amarkal-ui-component");t.amarkalUIForm("setData",e),o.each(function(){t.amarkalUIForm("isVisible",a(this).amarkalUIComponent("getName"))||a(this).parents(".amarkal-shortcode-field").hide()}),o.on("amarkal.show",function(){a(this).parents(".amarkal-shortcode-field").show(),a(this).amarkalUIComponent("refresh")}).on("amarkal.hide",function(){a(this).parents(".amarkal-shortcode-field").hide()})},t.prototype.onClose=function(){this.shortcode.ed.windowManager.close()},t.prototype.onInsert=function(){var e={},t=this.shortcode.placeholder.encodeValue,o=a(this.shortcode.ed.selection.getNode());a("#"+this.shortcode.id+".mce-window").find(".amarkal-ui-component").each(function(){var o=a(this).amarkalUIComponent("getValue"),n=a(this).attr("amarkal-component-name");e[n]=t(o)}),void 0!==o.attr("data-amarkal-shortcode")&&o.remove(),this.shortcode.ed.selection.setContent(this.shortcode.parseTemplate(this.shortcode.config.template,e)),this.shortcode.ed.windowManager.close()},o.prototype.edit=function(e){var t=e.attr("data-amarkal-shortcode"),o=wp.shortcode.next(this.shortcode.id,window.decodeURIComponent(t)),n=a.extend({},o.shortcode.attrs.named,{content:o.shortcode.content});this.shortcode.ed.execCommand(this.shortcode.config.cmd,this.decodeValues(n)),this.shortcode.ed.selection.select(e[0])},o.prototype.delete=function(e){e.remove()},o.prototype.decodeValue=function(e){try{return JSON.parse(decodeURIComponent(e))}catch(t){return this.decodeNonJSONEncodedValue(e)}},o.prototype.decodeNonJSONEncodedValue=function(e){return-1!==e.indexOf(",")?e.split(","):e},o.prototype.decodeValues=function(e){var t=this,o={};return Object.keys(e).forEach(function(n){o[n]=t.decodeValue(e[n])}),o},o.prototype.encodeValue=function(e){return encodeURIComponent(JSON.stringify(e))},o.prototype.encodeValues=function(e){var t={};return Object.keys(e).forEach(function(o){t[o]=this.encodeValue(e[o])}),t},n.prototype.init=function(){var e=this;this.ed.addCommand(this.config.cmd,function(t){void 0===t&&(t=e.getDefaultValues()),e.ed.windowManager.open({title:e.config.title,onOpen:e.popup.onOpen.bind(e.popup,t),width:e.config.width,height:e.config.height,id:e.id,html:e.config.html,buttons:[{text:"Insert",classes:"widget btn primary first abs-layout-item",disabled:!1,onclick:e.popup.onInsert.bind(e.popup)},{text:"Close",onclick:e.popup.onClose.bind(e.popup)}]}),a("#"+e.id+" .amarkal-ui-component").each(function(){a(this).amarkalUIComponent("refresh")})}),e.ed.on("BeforeSetContent",function(t){t.content=e.replaceShortcodes(t.content)}),e.ed.on("PostProcess",function(t){t.get&&(t.content=e.restoreShortcodes(t.content))}),e.ed.on("click",function(t){var o=a(t.target),n=a(t.target.parentElement),i=decodeURIComponent(n.attr("data-amarkal-shortcode"));"I"===t.target.nodeName&&n.hasClass("amarkal-shortcode-placeholder")&&wp.shortcode.next(e.id,i)&&(o.is(":first-child")&&e.placeholder.delete.call(e.placeholder,n),o.is(":last-child")&&e.placeholder.edit.call(e.placeholder,n))})},n.prototype.getDefaultValues=function(){for(var e={},t=0;t<this.config.fields.length;t++){var o=this.config.fields[t];void 0!==o.default&&(e[o.name]=o.default)}return e},n.prototype.parseTemplate=function(e,t){return e.replace(/(\{\{([\w\d-]*)\}\})/g,function(e,o,n){return t[n.trim()]})},n.prototype.replaceShortcodes=function(e){var t=this;return wp.shortcode.replace(this.id,e,function(e){return t.html(e)})},n.prototype.restoreShortcodes=function(e){return e.replace(/(<div( [^>]+)?>)*<i><\/i><i><\/i>\.(?:<\/div>)*/g,function(e,t){var o=function(e,t){return(t=new RegExp(t+'="([^"]+)"').exec(e))?window.decodeURIComponent(t[1]):""}(t,"data-amarkal-shortcode");return o?"<p>"+o+"</p>":e})},n.prototype.html=function(e){var t=this.config.placeholder_class?" "+this.config.placeholder_class:"";return wp.html.string({tag:"div",content:"<i></i><i></i>.",attrs:{class:"amarkal-shortcode-placeholder mceItem"+t,"data-amarkal-shortcode":window.encodeURIComponent(e.string()),"data-title":this.config.title,"data-subtitle":this.config.placeholder_subtitle?this.parseTemplate(this.config.placeholder_subtitle,this.placeholder.decodeValues(e.attrs.named)):"",style:this.config.placeholder_icon?"background-image:url("+this.config.placeholder_icon+")":""}})};var a=window.jQuery;e.Shortcode={init:function(){var e=JSON.parse(a("#amarkal-shortcode-json").html());tinymce.create("tinymce.plugins.amarkal_shortcode",{init:function(t,o){for(var a in e){new n(a,e[a],t).init()}}}),tinymce.PluginManager.add("amarkal_shortcode",tinymce.plugins.amarkal_shortcode)}},a(document).ready(function(){Amarkal.Shortcode.init()})}("undefined"==typeof Amarkal?Amarkal={}:Amarkal);
//# sourceMappingURL=amarkal-shortcode.min.js.map